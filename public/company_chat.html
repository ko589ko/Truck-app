<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒ£ãƒƒãƒˆï¼ˆä¼šç¤¾ â†’ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#d9ecff; font-family:'Noto Sans JP',sans-serif; }
    .chat-box { max-width:720px; margin:auto; background:#fff; padding:20px;
      border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.1); margin-top:30px; }
    h3 { text-align:center; color:#1565c0; font-weight:700; margin-bottom:10px; }
    #messages { height:60vh; overflow-y:auto; border:1px solid #bbdefb;
      border-radius:10px; padding:12px; background:#f9fcff; margin-bottom:12px; }
    .msg { padding:10px 14px; border-radius:10px; margin-bottom:12px; max-width:75%; font-size:15px; }
    .mine { background:#4caf50; color:white; margin-left:auto; }
    .other { background:#1976d2; color:white; margin-right:auto; }
    .time { font-size:11px; opacity:0.7; margin-top:3px; }
    #sendBox { display:flex; gap:8px; }
    #sendInput { flex:1; border-radius:8px; border:1px solid #90caf9; padding:8px; }
    .back-btn { width:100%; padding:10px; border-radius:8px; background:#e3f2fd;
      border:1px solid #1565c0; font-weight:600; margin-top:12px; }
  </style>
</head>

<body>

<audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

<div class="chat-box">

  <h3>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆï¼ˆä¼šç¤¾å´ï¼‰</h3>
  <p style="text-align:center;">ç›¸æ‰‹ï¼š<b id="driverName" style="color:#1565c0;"></b></p>
  <hr>

  <div id="messages">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="sendBox">
    <input id="sendInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button class="btn btn-success" onclick="sendMessage()">é€ä¿¡</button>
  </div>

  <button class="back-btn" onclick="location.href='company_chat_list.html'">â† æˆ»ã‚‹</button>
</div>

<script>
const params = new URLSearchParams(location.search);
const driver = params.get("driver");
document.getElementById("driverName").textContent = driver;

let lastMessageCount = 0;

function formatTime(ts) {
  const d = new Date(ts);
  return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

async function loadMessages() {
  const res = await fetch(`/api/messages?driver=${encodeURIComponent(driver)}`);
  const data = await res.json();

  if (data.length > lastMessageCount && lastMessageCount !== 0) {
    document.getElementById("notifySound").play().catch(()=>{});
  }
  lastMessageCount = data.length;

  const box = document.getElementById("messages");
  box.innerHTML = data.map(m => `
    <div class="msg ${m.role.trim() === 'company' ? 'mine' : 'other'}">
      <div>${m.message}</div>
      <div class="time">${formatTime(m.timestamp)}</div>
    </div>
  `).join("");

  box.scrollTop = box.scrollHeight;
}

async function sendMessage() {
  const el = document.getElementById("sendInput");
  const text = el.value.trim();

  if (!text) {
    alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  await fetch("/api/messages", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ driver, role:"company", message:text })
  });

  el.value = "";
  lastMessageCount++;
  loadMessages();
}

document.getElementById("sendInput").addEventListener("keydown", (e)=>{
  if(e.key==="Enter") sendMessage();
});

setInterval(loadMessages, 1500);
loadMessages();
</script>

</body>
</html>
